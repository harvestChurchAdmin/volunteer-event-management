<%- include('../partials/header', { title, user: locals.user, layoutVariant: 'admin' }) %>

<%
function parseLocalDate(txt) {
  if (!txt) return null;
  const s = String(txt).trim();
  if (!s) return null;
  let dt = null;
  if (/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(s)) {
    const d = new Date(s);
    if (!isNaN(d)) dt = d;
  }
  if (!dt) {
    const match = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})/);
    if (match) {
      const [, Y, Mo, D, H, Mi] = match;
      dt = new Date(+Y, +Mo - 1, +D, +H, +Mi);
    }
  }
  if (!dt || isNaN(dt)) return null;
  return dt;
}

function pad2(value) {
  return String(value).padStart(2, '0');
}

function fmt12(txt) {
  const dt = parseLocalDate(txt);
  if (!dt) return txt || '';
  const opts = { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' };
  return dt.toLocaleString(undefined, opts);
}

function canonicalLocal(txt) {
  const dt = parseLocalDate(txt);
  if (!dt) return txt || '';
  return `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
}

function canonicalInputValue(txt) {
  const dt = parseLocalDate(txt);
  if (!dt) return '';
  return `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())}T${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
}

function toTimestamp(txt) {
  const dt = parseLocalDate(txt);
  return dt ? dt.getTime() : Number.NEGATIVE_INFINITY;
}
%>

<section class="page-header page-shell">
  <div>
    <a href="/admin/dashboard" class="btn-link">&larr; Back to dashboard</a>
    <h1><%= event.name %></h1>
    <% if (event.description) { %>
      <p class="muted"><%= event.description %></p>
    <% } %>
    <p class="page-subtitle"><%= fmt12(event.date_start) %> – <%= fmt12(event.date_end) %></p>
  </div>
  <div class="page-header__actions">
    <form action="/admin/event/<%= event.event_id %>/publish" method="POST">
      <input type="hidden" name="publish" value="<%= event.is_published ? '0' : '1' %>">
      <input type="hidden" name="redirectTo" value="/admin/event/<%= event.event_id %>">
      <button class="btn <%= event.is_published ? 'btn-secondary' : 'btn-primary' %>">
        <%= event.is_published ? 'Unpublish' : 'Publish' %>
      </button>
    </form>
    <button class="btn btn-ghost" data-open="#editEventModal">Edit event</button>
    <form action="/admin/event/<%= event.event_id %>/delete" method="POST" class="inline-form js-confirm" data-confirm="Delete this event and all associated stations, time blocks, and volunteers? This cannot be undone." data-confirm-cta="Delete">
      <button type="submit" class="btn btn-danger">Delete event</button>
    </form>
  </div>
</section>

<%- include('../partials/messages', { messages }) %>

<%
  const stations = Array.isArray(event.stations) ? event.stations : Object.values(event.stations || {});
%>

<section class="page-section page-shell">
  <div class="section-header">
    <h2>Stations</h2>
    <button id="newStationBtn" class="btn btn-primary" data-open="#newStationModal">Add station</button>
  </div>
  <% if (stations.length > 0) { %>
    <div class="station-grid js-station-list" data-event-id="<%= event.event_id %>">
  <% stations.forEach((station) => { %>
        <%
          const rawBlocks = Array.isArray(station.time_blocks)
            ? station.time_blocks
            : (station.time_blocks ? Object.values(station.time_blocks) : []);
          const sortedBlocks = rawBlocks.slice().sort((a, b) => toTimestamp(a.start_time) - toTimestamp(b.start_time));
        %>
        <article class="card station-card" data-station-id="<%= station.station_id %>" draggable="true">
          <header class="station-card__header">
            <div class="station-card__heading">
              <button class="btn btn-ghost station-toggle" type="button" data-station-id="<%= station.station_id %>" aria-pressed="false" aria-expanded="true" title="Collapse or expand station">
                <svg class="icon-chev" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="chev-fallback" aria-hidden="true">▾</span>
                <span class="sr-only">Collapse or expand station</span>
              </button>
              <div class="station-card__heading-text">
                <div class="station-card__heading-top">
                  <span class="drag-handle" aria-hidden="true" title="Drag to reorder station">☰</span>
                  <h2><%= station.name %></h2>
                </div>
              </div>
            </div>
            <div class="station-card__header-actions">
              <button class="btn btn-primary open-time-block-btn"
                      data-open="#timeBlockModal"
                      data-station-id="<%= station.station_id %>"
                      data-event-id="<%= event.event_id %>">
                Add time block
              </button>
              <button class="btn btn-ghost" data-open="#editStationModal-<%= station.station_id %>">Edit station</button>
              <form class="inline-form js-confirm"
                    data-confirm="Delete this station and all its time blocks? This cannot be undone."
                    data-confirm-cta="Delete"
                    action="/admin/station/<%= station.station_id %>/delete"
                    method="POST">
                <input type="hidden" name="eventId" value="<%= event.event_id %>">
                <button type="submit" class="btn btn-danger">Delete</button>
              </form>
            </div>
          </header>

          <% const stationAbout = station.about || station.description || ''; %>
          <% const stationDuties = station.duties || ''; %>
          <% if (stationAbout || stationDuties) { %>
            <div class="station-card__summary">
              <% if (stationAbout) { %>
                <div class="station-card__summary-item">
                  <h3>Description</h3>
                  <p><%= stationAbout %></p>
                </div>
              <% } %>
              <% if (stationDuties) { %>
                <div class="station-card__summary-item">
                  <h3>Duties</h3>
                  <p><%= stationDuties %></p>
                </div>
              <% } %>
            </div>
          <% } %>

          <% if (sortedBlocks.length > 0) { %>
            <ul class="admin-block-list" aria-label="Time blocks for station <%= station.name %>">
              <% sortedBlocks.forEach(function(block) { %>
                <li class="admin-block">
                  <div class="admin-block__main">
                    <div class="admin-block__times">
                      <div class="admin-block__pill">
                        <span>Start</span>
                        <strong><%= fmt12(block.start_time) %></strong>
                      </div>
                      <div class="admin-block__pill">
                        <span>End</span>
                        <strong><%= fmt12(block.end_time) %></strong>
                      </div>
                    </div>
                    <div class="admin-block__stats">
                      <div class="admin-block__metric">
                        <span class="admin-block__metric-label">Capacity</span>
                        <span class="capacity-display"><strong><%= block.capacity_needed %></strong></span>
                        <button type="button" class="btn btn-ghost btn-small edit-capacity-btn" data-block-id="<%= block.block_id %>">Edit</button>
                        <form class="inline-form capacity-edit-form" data-block-id="<%= block.block_id %>" action="/admin/block/<%= block.block_id %>/edit" method="POST" style="display:none;">
                          <input type="hidden" name="eventId" value="<%= event.event_id %>">
                          <input type="number" name="capacity_needed" min="1" value="<%= block.capacity_needed %>" aria-label="Capacity for block <%= block.block_id %>">
                          <button class="btn btn-primary btn-small" type="submit">Save</button>
                          <button class="btn btn-ghost btn-small cancel-capacity-btn" type="button">Cancel</button>
                        </form>
                      </div>
                      <div class="admin-block__metric">
                        <span class="admin-block__metric-label">Signed up</span>
                        <span class="admin-block__reserved">
                          <strong><%= Array.isArray(block.reservations) ? block.reservations.length : 0 %></strong> / <%= block.capacity_needed %>
                        </span>
                      </div>
                    </div>
                    <details class="admin-reservations" <%= block.reservations && block.reservations.length ? '' : 'open' %>>
                      <summary>Volunteers (<%= (block.reservations && block.reservations.length) || 0 %>)</summary>
                      <% if (block.reservations && block.reservations.length > 0) { %>
                        <ul class="admin-reservation-list">
                          <% block.reservations.forEach(function(reservation) { %>
                            <li class="admin-reservation">
                              <div class="admin-reservation__info">
                                <strong><%= reservation.name %></strong>
                                <span><%= reservation.email %></span>
                                <% if (reservation.phone) { %>
                                  <span><%= reservation.phone %></span>
                                <% } %>
                              </div>
                              <div class="admin-reservation__actions">
                                <button class="btn btn-ghost" data-open="#editReservationModal-<%= reservation.reservation_id %>">Edit</button>
                                <form class="inline-form js-confirm"
                                      data-confirm="Remove this volunteer from the time block?"
                                      data-confirm-cta="Remove"
                                      action="/admin/reservation/<%= reservation.reservation_id %>/delete"
                                      method="POST">
                                  <input type="hidden" name="eventId" value="<%= event.event_id %>">
                                  <button type="submit" class="btn btn-danger">Remove</button>
                                </form>
                              </div>
                            </li>

                            <%- include('../partials/modal-start', { id: 'editReservationModal-' + reservation.reservation_id, title: 'Edit Volunteer' }) %>
                              <form id="editReservationForm-<%= reservation.reservation_id %>" action="/admin/reservation/<%= reservation.reservation_id %>/edit" method="POST" novalidate>
                                <input type="hidden" name="eventId" value="<%= event.event_id %>">
                                <div class="form-grid">
                                  <div class="form-group">
                                    <label for="reservation-name-<%= reservation.reservation_id %>">Name</label>
                                    <input type="text" id="reservation-name-<%= reservation.reservation_id %>" name="name" value="<%= reservation.name %>" required>
                                  </div>
                                  <div class="form-group">
                                    <label for="reservation-email-<%= reservation.reservation_id %>">Email</label>
                                    <input type="email" id="reservation-email-<%= reservation.reservation_id %>" name="email" value="<%= reservation.email %>" required>
                                  </div>
                                  <div class="form-group">
                                    <label for="reservation-phone-<%= reservation.reservation_id %>">Phone</label>
                                    <input type="tel" id="reservation-phone-<%= reservation.reservation_id %>" name="phone" value="<%= reservation.phone %>">
                                  </div>
                                  <div class="form-group">
                                    <label for="reservation-block-<%= reservation.reservation_id %>">Assign to time block</label>
                                    <select id="reservation-block-<%= reservation.reservation_id %>" name="block_id">
                                      <% event.stations.forEach(function(optStation) { %>
                                        <%
                                          const optBlocks = Array.isArray(optStation.time_blocks)
                                            ? optStation.time_blocks
                                            : (optStation.time_blocks ? Object.values(optStation.time_blocks) : []);
                                          if (!optBlocks.length) return;
                                        %>
                                        <optgroup label="Station: <%= optStation.name %>">
                                          <% optBlocks.forEach(function(optBlock) { %>
                                            <option value="<%= optBlock.block_id %>" <%= optBlock.block_id === block.block_id ? 'selected' : '' %>>
                                              <%= fmt12(optBlock.start_time) %> – <%= fmt12(optBlock.end_time) %>
                                            </option>
                                          <% }) %>
                                        </optgroup>
                                      <% }) %>
                                    </select>
                                  </div>
                                </div>
                              </form>
                            <%- include('../partials/modal-end', { id: 'editReservationModal-' + reservation.reservation_id, formId: 'editReservationForm-' + reservation.reservation_id }) %>
                          <% }) %>
                        </ul>
                      <% } else { %>
                        <p class="muted">No volunteers yet.</p>
                      <% } %>
                    </details>
                  </div>
                  <div class="admin-block__actions">
                    <button class="btn btn-primary" data-open="#addReservationModal-<%= block.block_id %>" <%= block.is_full ? 'disabled title="Time block is full"' : '' %>>Add volunteer</button>
                    <button class="btn btn-ghost" data-open="#editBlockModal-<%= block.block_id %>">Edit block</button>
                    <form class="inline-form js-confirm"
                          data-confirm="Delete this time block? This cannot be undone."
                          data-confirm-cta="Delete"
                          action="/admin/block/<%= block.block_id %>/delete"
                          method="POST">
                      <input type="hidden" name="eventId" value="<%= event.event_id %>">
                      <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                  </div>
                </li>

                <%- include('../partials/modal-start', { id: 'addReservationModal-' + block.block_id, title: 'Add Volunteer to Time Block' }) %>
                  <form id="addReservationForm-<%= block.block_id %>" action="/admin/block/<%= block.block_id %>/reservations" method="POST" novalidate>
                    <input type="hidden" name="eventId" value="<%= event.event_id %>">
                    <div class="form-grid">
                      <div class="form-group">
                        <label for="add-reservation-name-<%= block.block_id %>">Name</label>
                        <input type="text" id="add-reservation-name-<%= block.block_id %>" name="name" required>
                      </div>
                      <div class="form-group">
                        <label for="add-reservation-email-<%= block.block_id %>">Email</label>
                        <input type="email" id="add-reservation-email-<%= block.block_id %>" name="email" required>
                      </div>
                      <div class="form-group">
                        <label for="add-reservation-phone-<%= block.block_id %>">Phone</label>
                        <input type="tel" id="add-reservation-phone-<%= block.block_id %>" name="phone">
                      </div>
                    </div>
                  </form>
                <%- include('../partials/modal-end', { id: 'addReservationModal-' + block.block_id, formId: 'addReservationForm-' + block.block_id }) %>

                <!-- Edit Block Modal -->
                <%- include('../partials/modal-start', { id: 'editBlockModal-' + block.block_id, title: 'Edit Time Block' }) %>
                  <form id="editBlockForm-<%= block.block_id %>" action="/admin/block/<%= block.block_id %>/edit" method="POST" novalidate>
                    <input type="hidden" name="eventId" value="<%= event.event_id %>">
        <div class="form-grid two">
          <div class="form-group">
            <label for="block-start-visible-<%= block.block_id %>">Start time</label>
            <input type="hidden"
                   id="block-start-hidden-<%= block.block_id %>"
                   name="start_time"
                   value="<%= canonicalLocal(block.start_time) %>">
            <input type="datetime-local"
                   id="block-start-visible-<%= block.block_id %>"
                   class="datetime-field"
                   data-datetime-role="start"
                   data-canonical-target="block-start-hidden-<%= block.block_id %>"
                   step="900"
                   value="<%= canonicalInputValue(block.start_time) %>"
                   required>
          </div>
                      <div class="form-group">
                        <label for="block-end-visible-<%= block.block_id %>">End time</label>
                        <input type="hidden"
                               id="block-end-hidden-<%= block.block_id %>"
                               name="end_time"
                               value="<%= canonicalLocal(block.end_time) %>">
                        <input type="datetime-local"
                               id="block-end-visible-<%= block.block_id %>"
                   class="datetime-field"
                   data-datetime-role="end"
                   data-canonical-target="block-end-hidden-<%= block.block_id %>"
                   step="900"
                   value="<%= canonicalInputValue(block.end_time) %>"
                   required>
          </div>
                      <div class="form-group">
                        <label for="block-capacity-<%= block.block_id %>">Capacity needed</label>
                        <input id="block-capacity-<%= block.block_id %>"
                               type="number"
                               name="capacity_needed"
                               min="1"
                               value="<%= block.capacity_needed %>"
                               required>
                      </div>
                    </div>
                  </form>
                <%- include('../partials/modal-end', { id: 'editBlockModal-' + block.block_id, formId: 'editBlockForm-' + block.block_id }) %>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="muted">No time blocks yet. Click “Add time block”.</p>
          <% } %>
        </article>

        <!-- Edit Station Modal -->
        <%- include('../partials/modal-start', { id: 'editStationModal-' + station.station_id, title: 'Edit Station' }) %>
          <form id="editStationForm-<%= station.station_id %>" action="/admin/station/<%= station.station_id %>/edit" method="POST" novalidate>
            <input type="hidden" name="eventId" value="<%= event.event_id %>">
            <div class="form-group">
              <label for="station-name-<%= station.station_id %>">Station name</label>
              <input id="station-name-<%= station.station_id %>" type="text" name="name" value="<%= station.name %>" required>
            </div>
            <div class="form-group">
              <label for="station-about-<%= station.station_id %>">Station description</label>
              <textarea id="station-about-<%= station.station_id %>" name="about" rows="3" placeholder="Describe the the station"><%= station.about || station.description || '' %></textarea>
            </div>
            <div class="form-group">
              <label for="station-duties-<%= station.station_id %>">Volunteer duties</label>
              <textarea id="station-duties-<%= station.station_id %>" name="duties" rows="3" placeholder="List expectations or tasks for volunteers"><%= station.duties || '' %></textarea>
            </div>
          </form>
        <%- include('../partials/modal-end', { id: 'editStationModal-' + station.station_id, formId: 'editStationForm-' + station.station_id }) %>
      <% }) %>
    </div>
  <% } else { %>
    <article class="card card--plain empty-state">
      <h2>No stations yet</h2>
      <p class="muted">Add a station to begin scheduling volunteer shifts for this event.</p>
    </article>
  <% } %>
</section>

<!-- Edit Event Modal -->
<%- include('../partials/modal-start', { id: 'editEventModal', title: 'Edit Event' }) %>
  <form id="editEventForm" action="/admin/event/<%= event.event_id %>/edit" method="POST" novalidate>
    <div class="form-group">
      <label for="edit-event-name">Event name</label>
      <input id="edit-event-name" type="text" name="name" value="<%= event.name %>" required>
    </div>
    <div class="form-group">
      <label for="edit-event-description">Description</label>
      <textarea id="edit-event-description" name="description"><%= event.description %></textarea>
    </div>
        <div class="form-grid two">
          <div class="form-group">
            <label for="edit-event-start-visible">Start</label>
            <input type="hidden"
                   id="edit-event-start-hidden"
                   name="date_start"
                   value="<%= canonicalLocal(event.date_start) %>">
            <input type="datetime-local"
                   id="edit-event-start-visible"
                   class="datetime-field"
                   data-datetime-role="start"
                   data-canonical-target="edit-event-start-hidden"
                   step="900"
                   value="<%= canonicalInputValue(event.date_start) %>"
                   required>
          </div>
          <div class="form-group">
            <label for="edit-event-end-visible">End</label>
            <input type="hidden"
                   id="edit-event-end-hidden"
                   name="date_end"
                   value="<%= canonicalLocal(event.date_end) %>">
            <input type="datetime-local"
                   id="edit-event-end-visible"
                   class="datetime-field"
                   data-datetime-role="end"
                   data-canonical-target="edit-event-end-hidden"
                   step="900"
                   value="<%= canonicalInputValue(event.date_end) %>"
                   required>
          </div>
        </div>
  </form>
<%- include('../partials/modal-end', { id: 'editEventModal', formId: 'editEventForm' }) %>

<!-- New Station Modal -->
<%- include('../partials/modal-start', { id: 'newStationModal', title: 'Add New Station' }) %>
  <form id="newStationForm" action="/admin/event/<%= event.event_id %>/stations" method="POST" novalidate>
    <div class="form-group">
      <label for="new-station-name">Station name</label>
      <input id="new-station-name" type="text" name="name" placeholder="Station Name" required>
    </div>
    <div class="form-group">
      <label for="new-station-about">Station description</label>
      <textarea id="new-station-about" name="about" placeholder="Example: Greeting table for first-time guests" rows="3"></textarea>
    </div>
    <div class="form-group">
      <label for="new-station-duties">Volunteer duties</label>
      <textarea id="new-station-duties" name="duties" placeholder="Example: Welcome guests, hand out info cards" rows="3"></textarea>
    </div>
    <% if (stations.length > 0) { %>
      <div class="form-group">
        <label for="station-copy-source">Copy existing station (optional)</label>
        <select id="station-copy-source" name="copyStationId">
          <option value="">Do not copy</option>
          <% stations.forEach(function(srcStation) { %>
            <option value="<%= srcStation.station_id %>"><%= srcStation.name %></option>
          <% }) %>
        </select>
        <p class="muted copy-hint">Copies time blocks. Provide a new name and station details above.</p>
      </div>
    <% } %>
  </form>
<%- include('../partials/modal-end', { id: 'newStationModal', formId: 'newStationForm' }) %>

<!-- Add Time Block Modal -->
<%- include('../partials/modal-start', { id: 'timeBlockModal', title: 'Add New Time Block' }) %>
  <form id="timeBlockForm" action="" method="POST" novalidate>
    <input type="hidden" name="event_id" value="<%= event.event_id %>">
        <div class="form-grid two">
          <div class="form-group">
            <label for="timeblock-start-visible">Start time</label>
            <input type="hidden" id="timeblock-start-hidden" name="start_time" value="">
            <input type="datetime-local"
                   id="timeblock-start-visible"
                   class="datetime-field"
                   data-datetime-role="start"
                   data-canonical-target="timeblock-start-hidden"
                   step="900"
                   required>
          </div>
          <div class="form-group">
            <label for="timeblock-end-visible">End time</label>
            <input type="hidden" id="timeblock-end-hidden" name="end_time" value="">
            <input type="datetime-local"
                   id="timeblock-end-visible"
                   class="datetime-field"
                   data-datetime-role="end"
                   data-canonical-target="timeblock-end-hidden"
                   step="900"
                   required>
          </div>
      <div class="form-group">
        <label for="timeblock-capacity">Capacity needed</label>
        <input id="timeblock-capacity" type="number" name="capacity_needed" min="1" value="1" required>
      </div>
    </div>
    <div class="form-errors notice notice--error" id="timeBlockErrors" style="display:none;"></div>
    <div class="form-group">
      <label>
        <input type="checkbox" id="timeblock-add-another" name="add_another" value="1">
        Add another after saving
      </label>
    </div>
  </form>
<%- include('../partials/modal-end', { id: 'timeBlockModal', formId: 'timeBlockForm' }) %>

<%- include('../partials/footer') %>
