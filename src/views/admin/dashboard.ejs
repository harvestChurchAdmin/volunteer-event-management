<%- include('../partials/header', { title, user: locals.user, layoutVariant: 'admin' }) %>

<section class="page-header page-shell">
  <div>
    <h1>Admin Dashboard</h1>
    <p class="page-subtitle">Organize events, stations, and time blocks in one streamlined space.</p>
  </div>
  <div class="page-header__actions page-header__actions--flush-right">
    <button id="newEventBtn" class="btn btn-primary" data-open="#newEventModal">Create new event</button>
  </div>
</section>

<%- include('../partials/messages', { messages }) %>

<%- include('../partials/modal-start', { id: 'newEventModal', title: 'Create New Event' }) %>
  <form id="newEventForm" action="/admin/event" method="POST" novalidate>
    <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
    <div class="form-grid">
      <div class="form-group full">
        <label for="event-name">Event name</label>
        <input type="text" id="event-name" name="name" required>
      </div>
      <div class="form-group full">
        <label for="event-description">Event description</label>
        <textarea id="event-description" name="description"></textarea>
        <p class="muted small">Supports simple formatting: <code>**bold**</code>, <code>*italic*</code>, <code>- bullet list</code>, blank line for new paragraph. <a href="/admin/help/formatting">Formatting help</a></p>
      </div>
      <div class="form-group">
        <label for="event-start-new">Start date &amp; time</label>
        <input type="hidden" id="event-start-new-hidden" name="date_start" value="">
        <input type="datetime-local"
               id="event-start-new"
               class="datetime-field"
               data-datetime-role="start"
               data-canonical-target="event-start-new-hidden"
               step="900"
               required>
      </div>
      <div class="form-group">
        <label for="event-end-new">End date &amp; time</label>
        <input type="hidden" id="event-end-new-hidden" name="date_end" value="">
        <input type="datetime-local"
               id="event-end-new"
               class="datetime-field"
               data-datetime-role="end"
               data-canonical-target="event-end-new-hidden"
               step="900"
               required>
      </div>
      <div class="form-group full">
        <label for="event-signup-mode">Sign-up type</label>
        <select id="event-signup-mode" name="signup_mode" required>
          <option value="schedule" selected>Volunteer schedule (stations &amp; time slots)</option>
          <option value="potluck">Food Prep (categories &amp; items, no times)</option>
        </select>
      </div>
    </div>
    <div class="card-actions">
      <button type="submit" class="btn btn-primary">Create event</button>
    </div>
  </form>
<%- include('../partials/modal-end', { id: 'newEventModal', formId: 'newEventForm' }) %>

<section class="page-section page-shell">
  <% if (events && events.length > 0) { %>
    <% 
      const now = new Date();
      const upcomingEvents = [];
      const pastEvents = [];
      events.forEach(event => {
        const endDate = new Date(event.date_end);
        const hasEnded = endDate && !Number.isNaN(endDate.getTime()) && endDate < now;
        (hasEnded ? pastEvents : upcomingEvents).push(event);
      });
    %>
    <article class="card card--table">
      <div class="card-header">
        <div>
          <h2>Events</h2>
          <p class="muted">Newest events appear first. Past events can be revealed from the section below.</p>
        </div>
      </div>
      <div class="table-scroll" role="region" aria-label="Existing events">
        <table class="table" id="adminEventsTable">
          <thead>
            <tr>
              <th class="col-type">Type</th>
              <th data-sort-key="name">Name</th>
              <th data-sort-key="date">Dates</th>
              <th data-sort-key="status">
                <span class="table-heading-with-help">
                  Status
                  <span class="table-heading-hint" tabindex="0" title="Draft: hidden from volunteers. Private link: requires the shared link. Published: listed on Upcoming Sign-ups." aria-label="Status legend: Draft is hidden from volunteers, Private link requires the shared link, Published appears on Upcoming Sign-ups.">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm-1.25 4.75h2.5v7h-2.5v-7Z"/></svg>
                    <span class="sr-only">Status legend</span>
                  </span>
                </span>
              </th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (upcomingEvents.length === 0) { %>
              <tr>
                <td colspan="5" class="table-empty muted">No active events right now. Expand “Show past events” below to view history.</td>
              </tr>
            <% } else { %>
              <% upcomingEvents.forEach(event => { %>
                <%- include('partials/event-row', { event, isPast: false, csrfToken: locals.csrfToken }) %>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </article>
    <% if (pastEvents.length > 0) { %>
      <details class="past-events" data-past-events>
        <summary class="past-events__summary">Show past events (<%= pastEvents.length %>)</summary>
        <div class="past-events__body">
          <div class="table-scroll" role="region" aria-label="Past events">
            <table class="table">
              <thead>
                <tr>
                  <th class="col-type">Type</th>
                  <th>Name</th>
                  <th>Dates</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% pastEvents.forEach(event => { %>
                  <%- include('partials/event-row', { event, isPast: true, csrfToken: locals.csrfToken }) %>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </details>
    <% } %>
  <% } else { %>
    <article class="card card--plain empty-state">
      <h2>No events created yet</h2>
      <p class="muted">Start by creating your first event, then add stations and time blocks to open volunteer opportunities.</p>
      <div class="action-row">
        <button class="btn btn-primary" data-open="#newEventModal">Create your first event</button>
      </div>
    </article>
  <% } %>
</section>


<%- include('../partials/footer') %>
