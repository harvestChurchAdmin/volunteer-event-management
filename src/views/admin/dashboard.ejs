<%- include('../partials/header', { title, user: locals.user, layoutVariant: 'admin' }) %>

<section class="page-header page-shell">
  <div>
    <h1>Admin Dashboard</h1>
    <p class="page-subtitle">Organize events, stations, and time blocks in one streamlined space.</p>
  </div>
  <div class="page-header__actions">
    <button id="newEventBtn" class="btn btn-primary" data-open="#newEventModal">Create new event</button>
  </div>
</section>

<%- include('../partials/messages', { messages }) %>

<%- include('../partials/modal-start', { id: 'newEventModal', title: 'Create New Event' }) %>
  <form id="newEventForm" action="/admin/event" method="POST" novalidate>
    <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
    <div class="form-grid">
      <div class="form-group full">
        <label for="event-name">Event name</label>
        <input type="text" id="event-name" name="name" required>
      </div>
      <div class="form-group full">
        <label for="event-description">Event description</label>
        <textarea id="event-description" name="description"></textarea>
        <p class="muted small">Supports simple formatting: <code>**bold**</code>, <code>*italic*</code>, <code>- bullet list</code>, blank line for new paragraph. <a href="/admin/help/formatting">Formatting help</a></p>
      </div>
      <div class="form-group">
        <label for="event-start-new">Start date &amp; time</label>
        <input type="hidden" id="event-start-new-hidden" name="date_start" value="">
        <input type="datetime-local"
               id="event-start-new"
               class="datetime-field"
               data-datetime-role="start"
               data-canonical-target="event-start-new-hidden"
               step="900"
               required>
      </div>
      <div class="form-group">
        <label for="event-end-new">End date &amp; time</label>
        <input type="hidden" id="event-end-new-hidden" name="date_end" value="">
        <input type="datetime-local"
               id="event-end-new"
               class="datetime-field"
               data-datetime-role="end"
               data-canonical-target="event-end-new-hidden"
               step="900"
               required>
      </div>
      <div class="form-group full">
        <label for="event-signup-mode">Sign-up type</label>
        <select id="event-signup-mode" name="signup_mode" required>
          <option value="schedule" selected>Volunteer schedule (stations &amp; time slots)</option>
          <option value="potluck">Potluck (categories &amp; items, no times)</option>
        </select>
      </div>
    </div>
    <div class="card-actions">
      <button type="submit" class="btn btn-primary">Create event</button>
    </div>
  </form>
<%- include('../partials/modal-end', { id: 'newEventModal', formId: 'newEventForm' }) %>

<section class="page-section page-shell">
  <% if (events && events.length > 0) { %>
    <% const now = new Date(); %>
    <article class="card card--table">
      <div class="card-header">
        <div>
          <h2>Events</h2>
          <p class="muted">Newest events appear first. Past events are clearly labeled.</p>
        </div>
      </div>
      <div class="table-scroll" role="region" aria-label="Existing events">
        <table class="table" id="adminEventsTable">
          <thead>
            <tr>
              <th class="col-type">Type</th>
              <th data-sort-key="name">Name</th>
              <th data-sort-key="date">Dates</th>
              <th data-sort-key="status">Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% events.forEach(event => { %>
              <%
                const endDate = new Date(event.date_end);
                const isPast = endDate && !Number.isNaN(endDate.getTime()) && endDate < now;
                const statusText = event.is_published ? 'Published' : 'Draft';
                const sortStatus = (isPast ? 'past_' : 'upcoming_') + (event.is_published ? 'published' : 'draft');
              %>
              <tr class="event-row <%= event.is_published ? 'event-row--published' : 'event-row--draft' %> <%= isPast ? 'event-row--past' : '' %>"
                  data-event-id="<%= event.event_id %>"
                  data-sort-name="<%= (event.name || '').toLowerCase() %>"
                  data-sort-date="<%= event.date_start %>"
                  data-sort-status="<%= sortStatus %>">
                <td data-th="Type" class="col-type">
                  <span class="type-icon <%= (String(event.signup_mode||'')==='potluck') ? 'type-icon--potluck' : 'type-icon--schedule' %>"
                        title="<%= (String(event.signup_mode||'')==='potluck') ? 'Potluck event' : 'Scheduled event' %>"
                        aria-label="<%= (String(event.signup_mode||'')==='potluck') ? 'Potluck event' : 'Scheduled event' %>">
                    <% if (String(event.signup_mode||'')==='potluck') { %>
                      <!-- Bowl with steam icon for Potluck -->
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <!-- Steam -->
                        <path d="M9 5.5c0 1-.8 1.3-.8 2.2 0 .4.1.8.3 1.1M12 5.5c0 1-.8 1.3-.8 2.2 0 .4.1.8.3 1.1M15 5.5c0 1-.8 1.3-.8 2.2 0 .4.1.8.3 1.1" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                        <!-- Bowl -->
                        <path d="M6 11h12v1.2a5.3 5.3 0 0 1-5.3 5.3H11.3A5.3 5.3 0 0 1 6 12.2V11Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                    <% } else { %>
                      <!-- Refined calendar icon -->
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="3.5" y="5" width="17" height="15.5" rx="2.5" ry="2.5" fill="none" stroke="currentColor" stroke-width="1.8"/>
                        <path d="M8 3.5v3M16 3.5v3M3.5 10.5h17" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                      </svg>
                    <% } %>
                  </span>
                </td>
                <td data-th="Name">
                  <strong><%= event.name %></strong>
                  <% if (isPast) { %>
                    <span class="muted small event-label-past">Past event</span>
                  <% } %>
                </td>
                <td data-th="Dates">
                  <%= new Date(event.date_start).toLocaleString(undefined, { month:'short', day:'numeric', hour:'numeric', minute:'2-digit' }) %>
                  &nbsp;–&nbsp;
                  <%= new Date(event.date_end).toLocaleString(undefined, { month:'short', day:'numeric', hour:'numeric', minute:'2-digit' }) %>
                </td>
                <td data-th="Status">
                  <span class="status-pill <%= event.is_published ? 'status-pill--live' : 'status-pill--draft' %>">
                    <%= statusText %>
                  </span>
                </td>
                <td data-th="Actions" class="row-actions">
                  <a href="/admin/event/<%= event.event_id %>" class="btn btn-primary">Manage</a>
                  <details class="dropdown dropdown--float" style="display:inline-block;margin-left:6px;">
                    <summary class="btn btn-accent">Actions</summary>
                    <div class="dropdown__menu">
                      <a class="dropdown__link" href="/admin/event/<%= event.event_id %>?edit=1">
                        <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4 17.25V20h2.75l8.086-8.086-2.75-2.75L4 17.25ZM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.33-2.33a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.83-1.83Z"/></svg>
                        Edit event…
                      </a>
                      <a class="dropdown__link"
                         href="<%= event.is_published
                           ? ('/events/' + event.event_id + '?return=' + encodeURIComponent('/admin/dashboard'))
                           : ('/events/' + event.event_id + '?preview=1&return=' + encodeURIComponent('/admin/dashboard')) %>">
                        <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 4a8 8 0 1 0 0 16 8 8 0 0 0 0-16Zm1 4h-2v4h4v-2h-2V8Z"/></svg>
                        <%= event.is_published ? 'View public page' : 'Preview public page' %>
                      </a>
                      <form action="/admin/event/<%= event.event_id %>/publish" method="POST" class="inline-form dropdown__item">
                        <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
                        <input type="hidden" name="publish" value="<%= event.is_published ? '0' : '1' %>">
                        <input type="hidden" name="redirectTo" value="/admin/dashboard">
                        <button type="submit" class="dropdown__link">
                          <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M5 12h14v2H5v-2Zm0-7h14v2H5V5Zm0 14h14v2H5v-2Z"/></svg>
                          <%= event.is_published ? 'Unpublish' : 'Publish' %>
                        </button>
                      </form>
                      <form action="/admin/event/<%= event.event_id %>/copy" method="POST" class="inline-form dropdown__item js-confirm" data-confirm="Create a copy of this event (stations and time blocks only)?" data-confirm-cta="Copy">
                        <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
                        <button type="submit" class="dropdown__link">
                          <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v14h13a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"/></svg>
                          Copy event
                        </button>
                      </form>
                      <form action="/admin/event/<%= event.event_id %>/delete" method="POST" class="inline-form js-confirm dropdown__item" data-confirm="Delete this event and all of its stations, time blocks, and volunteers? This cannot be undone." data-confirm-cta="Delete">
                        <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
                        <button type="submit" class="dropdown__link btn-danger">
                          <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M6 7h12l-1 14H7L6 7Zm2-3h8l1 2H7l1-2Z"/></svg>
                          Delete
                        </button>
                      </form>
                    </div>
                  </details>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </article>
  <% } else { %>
    <article class="card card--plain empty-state">
      <h2>No events created yet</h2>
      <p class="muted">Start by creating your first event, then add stations and time blocks to open volunteer opportunities.</p>
      <div class="action-row">
      <button class="btn btn-primary" data-open="#newEventModal">Create your first event</button>
    </div>
  </article>
<% } %>
</section>

<%- include('../partials/footer') %>
