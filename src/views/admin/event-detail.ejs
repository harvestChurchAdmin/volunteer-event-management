<%- include('../partials/header', { title, user: locals.user, layoutVariant: 'admin' }) %>

<!--
  Admin Event Detail
  Provides a single page view for managing stations, time blocks, and volunteer
  reservations. Helper functions below keep the presentation logic tidy.
-->

<%
function parseLocalDate(txt) {
  if (!txt) return null;
  const s = String(txt).trim();
  if (!s) return null;
  let dt = null;
  if (/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(s)) {
    const d = new Date(s);
    if (!isNaN(d)) dt = d;
  }
  if (!dt) {
    const match = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})/);
    if (match) {
      const [, Y, Mo, D, H, Mi] = match;
      dt = new Date(+Y, +Mo - 1, +D, +H, +Mi);
    }
  }
  if (!dt || isNaN(dt)) return null;
  return dt;
}

function pad2(value) {
  return String(value).padStart(2, '0');
}

function fmt12(txt) {
  const dt = parseLocalDate(txt);
  if (!dt) return txt || '';
  const opts = { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' };
  return dt.toLocaleString(undefined, opts);
}

function canonicalLocal(txt) {
  const dt = parseLocalDate(txt);
  if (!dt) return txt || '';
  return `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
}

function canonicalInputValue(txt) {
  const dt = parseLocalDate(txt);
  if (!dt) return '';
  return `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())}T${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
}

function toTimestamp(txt) {
  const dt = parseLocalDate(txt);
  return dt ? dt.getTime() : Number.NEGATIVE_INFINITY;
}

const stations = Array.isArray(event.stations) ? event.stations : Object.values(event.stations || {});
const isPotluck = String(event.signup_mode || '').toLowerCase() === 'potluck';
const slotTotals = stations.reduce((acc, station) => {
  const blocks = Array.isArray(station.time_blocks)
    ? station.time_blocks
    : (station.time_blocks ? Object.values(station.time_blocks) : []);
  blocks.forEach((block) => {
    const capacity = Number(block && block.capacity_needed) || 0;
    const filled = Array.isArray(block && block.reservations) ? block.reservations.length : 0;
    acc.capacity += capacity;
    acc.filled += filled;
  });
  return acc;
}, { capacity: 0, filled: 0 });
const slotPercent = slotTotals.capacity > 0
  ? Math.round((slotTotals.filled / slotTotals.capacity) * 100)
  : 0;
const publishState = String(event.publish_state || (event.is_published ? 'published' : 'draft'));
const isDraft = publishState === 'draft';
const isPrivate = publishState === 'private';
const isPublic = publishState === 'published';
const sharePath = '/events/' + event.event_id;
const absoluteShareUrl = (typeof shareUrl === 'string' && shareUrl) ? shareUrl : sharePath;
const shareUrlDisplay = absoluteShareUrl.replace(/^https?:\/\//i, '');
%>

<!-- Page header: core event metadata + publish/delete actions -->
<section class="page-header page-shell page-header--two-col admin-event-header">
  <div class="page-header__back">
    <a href="/admin/dashboard" class="btn-link">&larr; Back to dashboard</a>
  </div>
  <div class="page-header__primary">
    <h1>
      <span class="type-icon <%= isPotluck ? 'type-icon--potluck' : 'type-icon--schedule' %>" title="<%= isPotluck ? 'Potluck event' : 'Scheduled event' %>" aria-label="<%= isPotluck ? 'Potluck event' : 'Scheduled event' %>">
        <% if (isPotluck) { %>
          <!-- Bowl with steam icon for Potluck -->
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <!-- Steam -->
            <path d="M9 5.5c0 1-.8 1.3-.8 2.2 0 .4.1.8.3 1.1M12 5.5c0 1-.8 1.3-.8 2.2 0 .4.1.8.3 1.1M15 5.5c0 1-.8 1.3-.8 2.2 0 .4.1.8.3 1.1" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
            <!-- Bowl -->
            <path d="M6 11h12v1.2a5.3 5.3 0 0 1-5.3 5.3H11.3A5.3 5.3 0 0 1 6 12.2V11Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        <% } else { %>
          <!-- Refined calendar icon -->
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <rect x="3.5" y="5" width="17" height="15.5" rx="2.5" ry="2.5" fill="none" stroke="currentColor" stroke-width="1.8"/>
            <path d="M8 3.5v3M16 3.5v3M3.5 10.5h17" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
        <% } %>
      </span>
      <%= event.name %>
    </h1>
    <% if (event.description) { %>
      <div class="rich-text muted"><%- helpers.renderRichText(event.description) %></div>
    <% } %>
    <p class="page-subtitle"><%= fmt12(event.date_start) %> – <%= fmt12(event.date_end) %></p>
    <% if (slotTotals.capacity > 0) { %>
      <div class="event-slot-summary" role="status" aria-live="polite">
        <span class="event-slot-summary__metric">
          <strong><%= slotTotals.filled %></strong> filled
        </span>
        <span class="event-slot-summary__slash">/</span>
        <span class="event-slot-summary__metric"><%= slotTotals.capacity %> total opportunities</span>
        <span class="event-slot-summary__pct">(<%= slotPercent %>% full)</span>
      </div>
    <% } %>
  </div>
  <div class="page-header__actions page-header__actions--flush-right">
    <div class="header-actions__row">
      <a class="btn-link"
         href="<%= isDraft
           ? (sharePath + '?preview=1&return=' + encodeURIComponent('/admin/event/' + event.event_id))
           : (sharePath + '?return=' + encodeURIComponent('/admin/event/' + event.event_id)) %>">
        <%= isDraft ? 'Preview public page' : (isPrivate ? 'Open private link' : 'View public page') %>
      </a>
      <details class="dropdown dropdown--float">
        <summary class="btn btn-accent">Actions</summary>
        <div class="dropdown__menu">
          <a class="dropdown__link" href="/admin/event/<%= event.event_id %>/print?auto=1" target="_blank" rel="noopener">
            <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M6 9V3h12v6h2a2 2 0 0 1 2 2v6h-4v4H8v-4H4v-6a2 2 0 0 1 2-2h0Zm2-4v4h8V5H8Zm8 10H8v4h8v-4Z"/></svg>
            Printable PDF
          </a>
          <a class="dropdown__link" href="/admin/event/<%= event.event_id %>/export-skeleton.csv">
            <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M5 4h14v2H5V4Zm0 5h14v2H5V9Zm0 5h8v2H5v-2Z"/></svg>
            Export skeleton (no contacts)
          </a>
          <a class="dropdown__link" href="/admin/event/<%= event.event_id %>/export.csv">
            <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 3v10.586l3.293-3.293 1.414 1.414L12 17.414l-4.707-4.707 1.414-1.414L11 13.586V3h1ZM5 19h14v2H5z"/></svg>
            Quick Export
          </a>
          <button class="dropdown__link" data-open="#exportCsvModal" type="button">
            <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 5h18v2H3V5Zm0 6h18v2H3v-2Zm0 6h18v2H3v-2Z"/></svg>
            Advanced Export
          </button>
          <button class="dropdown__link" data-open="#editEventModal" type="button">
            <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4 17.25V20h2.75l8.086-8.086-2.75-2.75L4 17.25ZM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.33-2.33a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.83-1.83Z"/></svg>
            Edit event…
          </button>
          <form action="/admin/event/<%= event.event_id %>/delete" method="POST" class="inline-form js-confirm dropdown__item"
                data-confirm="Delete this event and all associated stations, time blocks, and volunteers? This cannot be undone."
                data-confirm-cta="Delete">
            <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
            <button type="submit" class="dropdown__link btn-danger">
              <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M6 7h12l-1 14H7L6 7Zm2-3h8l1 2H7l1-2Z"/></svg>
              Delete event
            </button>
          </form>
        </div>
      </details>
    </div>
    <form action="/admin/event/<%= event.event_id %>/publish" method="POST" class="publish-form">
      <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
      <input type="hidden" name="redirectTo" value="/admin/event/<%= event.event_id %>">
      <label for="publish-state" class="sr-only">Visibility</label>
      <div class="publish-form__row">
        <select id="publish-state" name="publish_state">
          <option value="draft" <%= isDraft ? 'selected' : '' %>>Draft</option>
          <option value="private" <%= isPrivate ? 'selected' : '' %>>Private</option>
          <option value="published" <%= isPublic ? 'selected' : '' %>>Public</option>
        </select>
        <button class="btn btn-primary" type="submit">Update</button>
      </div>
      <div class="muted small" style="text-align:right;">
        <button type="button" class="btn-link small" data-open="#visibilityHelpModal">What do these mean?</button>
      </div>
    </form>
    <% if (!isDraft) { %>
      <button type="button"
              class="btn-link share-link__copy-btn share-link__copy-btn--minimal"
              data-copy-share-link="<%= absoluteShareUrl %>"
              data-label-default="<%= isPrivate ? 'Copy private link' : 'Copy link' %>"
              data-label-success="Copied!"
              data-label-error="Unable to copy">
        <svg class="share-link__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15 3a3 3 0 0 1 3 3v5a3 3 0 0 1-3 3h-1v-2h1a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v2H6V6a3 3 0 0 1 3-3h6Zm-6 8a3 3 0 0 1 3 3v5a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-5a3 3 0 0 1 3-3h3Zm0 2H6a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-5a1 1 0 0 0-1-1Z"/></svg>
        <span class="share-link__copy-label" aria-live="polite"><%= isPrivate ? 'Copy private link' : 'Copy link' %></span>
      </button>
    <% } %>
  </div>
</section>

<%
  const visibilityModalFooter = `
    <button class="btn btn-secondary" data-close="#visibilityHelpModal">Close</button>
  `;
%>
<%- include('../partials/modal-start', { id: 'visibilityHelpModal', title: 'Publish & Visibility' }) %>
  <div class="visibility-help">
    <p class="muted">Choose how this event shows up for volunteers:</p>
    <div class="visibility-help__grid">
      <article class="visibility-help__card">
        <div class="visibility-help__badge visibility-help__badge--draft">Draft</div>
        <p class="visibility-help__title">Admins only</p>
        <p class="muted small">Use while editing or planning. Hidden everywhere except for admins.</p>
      </article>
      <article class="visibility-help__card">
        <div class="visibility-help__badge visibility-help__badge--private">Private</div>
        <p class="visibility-help__title">Share with a direct link</p>
        <p class="muted small">Keeps the event off the public list but anyone with the link can sign up.</p>
      </article>
      <article class="visibility-help__card">
        <div class="visibility-help__badge visibility-help__badge--public">Public</div>
        <p class="visibility-help__title">Listed on Upcoming Sign-ups</p>
        <p class="muted small">Visible to everyone browsing the site and accessible via a direct link.</p>
      </article>
    </div>
    <div class="visibility-help__note">
      <strong>Tip:</strong> you can switch visibility at any time—existing stations and sign-ups stay intact.
    </div>
  </div>
<%- include('../partials/modal-end', { id: 'visibilityHelpModal', footer: visibilityModalFooter }) %>

<%- include('../partials/messages', { messages }) %>

<!-- Stations: listing + management modals -->
<section class="page-section page-shell">
  <div class="section-header">
    <h2><%= isPotluck ? 'Categories' : 'Stations' %></h2>
    <div class="section-header__actions">
      <button id="newStationBtn" class="btn btn-primary" data-open="#newStationModal"><%= isPotluck ? 'Add category' : 'Add station' %></button>
      <% if (stations.length > 0) { %>
        <button type="button"
                class="btn btn-ghost btn-small"
                data-open="#reorderStationsModal">
          <%= isPotluck ? 'Reorder categories' : 'Reorder stations' %>
        </button>
      <% } %>
      <div class="split-actions">
        <button type="button" class="btn btn-ghost btn-small js-expand-all">Expand all</button>
        <button type="button" class="btn btn-ghost btn-small js-collapse-all">Collapse all</button>
      </div>
    </div>
  </div>
  <% if (stations.length > 0) { %>
    <div class="station-grid js-station-list" data-event-id="<%= event.event_id %>" data-is-potluck="<%= isPotluck ? 'true' : 'false' %>">
  <% stations.forEach((station) => { %>
        <%
          const rawBlocks = Array.isArray(station.time_blocks)
            ? station.time_blocks
            : (station.time_blocks ? Object.values(station.time_blocks) : []);
          const sortedBlocks = rawBlocks.slice().sort((a, b) => {
            if (isPotluck) {
              const ao = (typeof a.item_order === 'number' && !Number.isNaN(a.item_order)) ? a.item_order : 0;
              const bo = (typeof b.item_order === 'number' && !Number.isNaN(b.item_order)) ? b.item_order : 0;
              if (ao !== bo) return ao - bo;
              return (a.block_id || 0) - (b.block_id || 0);
            }
            return toTimestamp(a.start_time) - toTimestamp(b.start_time);
          });
          const stationTotals = sortedBlocks.reduce((acc, block) => {
            const capacity = Number(block && block.capacity_needed) || 0;
            const filled = Array.isArray(block && block.reservations) ? block.reservations.length : 0;
            acc.capacity += capacity;
            acc.filled += filled;
            return acc;
          }, { capacity: 0, filled: 0 });
        %>
        <article class="card station-card" data-station-id="<%= station.station_id %>" draggable="true">
          <header class="station-card__header">
            <div class="station-card__heading">
              <button class="btn btn-ghost station-toggle" type="button" data-station-id="<%= station.station_id %>" aria-pressed="false" aria-expanded="true" title="Collapse or expand station">
                <svg class="icon-chev" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="chev-fallback" aria-hidden="true">▾</span>
                <span class="sr-only">Collapse or expand station</span>
              </button>
              <div class="station-card__heading-text">
                <div class="station-card__heading-top">
                  <span class="drag-handle" aria-hidden="true" title="Drag to reorder station">☰</span>
                  <h2><%= station.name %></h2>
                  <span class="station-card__heading-meta" aria-hidden="true">
                    <span class="station-card__badge">
                      <strong><%= stationTotals.filled %></strong>/<%= stationTotals.capacity %> filled
                    </span>
                  </span>
                </div>
                <span class="sr-only station-card__sr-metrics">Filled <%= stationTotals.filled %> of <%= stationTotals.capacity %> opportunities</span>
              </div>
            </div>
            <div class="station-card__header-actions">
              <button class="btn btn-primary open-time-block-btn"
                      data-open="#timeBlockModal"
                      data-station-id="<%= station.station_id %>"
                      data-event-id="<%= event.event_id %>">
                <%= isPotluck ? 'Add item' : 'Add time block' %>
              </button>
              <details class="dropdown dropdown--float">
                <summary class="btn btn-outline">Manage</summary>
                <div class="dropdown__menu">
                  <button class="dropdown__link" data-open="#editStationModal-<%= station.station_id %>" type="button">
                    <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4 17.25V20h2.75l8.086-8.086-2.75-2.75L4 17.25ZM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.33-2.33a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.83-1.83Z"/></svg>
                    Edit station…
                  </button>
                  <% if (isPotluck) { %>
                    <button class="dropdown__link" data-open="#reorderItemsModal-<%= station.station_id %>" type="button">
                      <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4 9h16v2H4V9Zm0 4h10v2H4v-2Z"/></svg>
                      Reorder items…
                    </button>
                  <% } %>
                  <form class="inline-form js-confirm dropdown__item"
                        data-confirm="Delete this station and all its time blocks? This cannot be undone."
                        data-confirm-cta="Delete"
                        action="/admin/station/<%= station.station_id %>/delete"
                        method="POST">
                    <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
                    <input type="hidden" name="eventId" value="<%= event.event_id %>">
                    <button type="submit" class="dropdown__link btn-danger">
                      <svg class="dropdown__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M6 7h12l-1 14H7L6 7Zm2-3h8l1 2H7l1-2Z"/></svg>
                      Delete station
                    </button>
                  </form>
                </div>
              </details>
            </div>
          </header>

          <% const stationAbout = station.about || station.description || ''; %>
          <% const stationDuties = station.duties || ''; %>
          <% if (stationAbout || stationDuties) { %>
            <div class="station-card__summary">
              <% if (stationAbout) { %>
                <div class="station-card__summary-item">
                  <h3>Description</h3>
                  <div class="rich-text"><%- helpers.renderRichText(stationAbout) %></div>
                </div>
              <% } %>
              <% if (stationDuties) { %>
                <div class="station-card__summary-item">
                  <h3>Duties</h3>
                  <div class="rich-text"><%- helpers.renderRichText(stationDuties) %></div>
                </div>
              <% } %>
            </div>
          <% } %>

          <% if (sortedBlocks.length > 0) { %>
            <ul class="admin-block-list" aria-label="<%= isPotluck ? 'Items' : 'Time blocks' %> for <%= station.name %>" data-station-id="<%= station.station_id %>">
              <% sortedBlocks.forEach(function(block) { %>
                <li class="admin-block" data-block-id="<%= block.block_id %>">
                  <div class="admin-block__main">
                    <% if (isPotluck) { %>
                      <div class="admin-block__times admin-block__times--potluck">
                        <div class="admin-block__pill admin-block__pill--item">
                          <span>Item</span>
                          <div class="admin-block__item-row">
                            <span class="block-drag-handle" aria-hidden="true" title="Drag to reorder item">☰</span>
                            <span class="admin-block__item-name"><%= block.title || '(untitled item)' %></span>
                          </div>
                        </div>
                        <% const hasFeeds = block.servings_min != null || block.servings_max != null; %>
                        <% if (hasFeeds) { %>
                          <div class="admin-block__pill admin-block__pill--feeds">
                            <span>Feeds</span>
                            <strong class="admin-block__feeds-value">
                              <%= (function(){
                                    const hasMin = typeof block.servings_min !== 'undefined' && block.servings_min != null;
                                    const hasMax = typeof block.servings_max !== 'undefined' && block.servings_max != null;
                                    if (hasMin && hasMax) return String(block.servings_min) + '–' + String(block.servings_max);
                                    if (hasMin) return String(block.servings_min);
                                    if (hasMax) return '≤' + String(block.servings_max);
                                    return '';
                                  })() %>
                            </strong>
                          </div>
                        <% } %>
                      </div>
                    <% } else { %>
                      <div class="admin-block__times">
                        <div class="admin-block__pill">
                          <span>Start</span>
                          <strong><%= fmt12(block.start_time) %></strong>
                        </div>
                        <div class="admin-block__pill">
                          <span>End</span>
                          <strong><%= fmt12(block.end_time) %></strong>
                        </div>
                      </div>
                    <% } %>
                    <div class="admin-block__stats">
                      <div class="admin-block__metric">
                        <span class="admin-block__metric-label">Slots</span>
                        <span class="capacity-display"><strong><%= block.capacity_needed %></strong></span>
                        <button type="button" class="btn btn-outline btn-small edit-capacity-btn" data-block-id="<%= block.block_id %>">Edit</button>
                        <form class="inline-form capacity-edit-form" data-block-id="<%= block.block_id %>" action="/admin/block/<%= block.block_id %>/edit" method="POST" style="display:none;">
                          <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
                          <input type="hidden" name="eventId" value="<%= event.event_id %>">
                          <input type="number" name="capacity_needed" min="1" value="<%= block.capacity_needed %>" aria-label="Capacity for block <%= block.block_id %>">
                          <button class="btn btn-primary btn-small" type="submit">Save</button>
                          <button class="btn btn-ghost btn-small cancel-capacity-btn" type="button">Cancel</button>
                        </form>
                      </div>
                      <div class="admin-block__metric">
                        <span class="admin-block__metric-label">Signed up</span>
                        <span class="admin-block__reserved">
                          <strong><%= Array.isArray(block.reservations) ? block.reservations.length : 0 %></strong> / <%= block.capacity_needed %>
                        </span>
                      </div>
                    </div>
                    <details class="admin-reservations" data-block-id="<%= block.block_id %>">
                      <summary>Volunteers (<%= (block.reservations && block.reservations.length) || 0 %>)</summary>
                      <% if (block.reservations && block.reservations.length > 0) { %>
                        <ul class="admin-reservation-list">
                          <% block.reservations.forEach(function(reservation) { %>
                            <li class="admin-reservation">
                              <div class="admin-reservation__info">
                                <div class="admin-reservation__name">
                                  <svg class="icon icon-person" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                    <path fill="currentColor" d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5Z"/>
                                  </svg>
                              <strong><%= reservation.name %></strong>
                            </div>
                            <span><%= reservation.email %></span>
                            <% if (reservation.phone) { %>
                              <span><%= reservation.phone %></span>
                            <% } %>
                            <% if (reservation.reservation_note) { %>
                              <span>Dish: <%= reservation.reservation_note %></span>
                            <% } %>
                          </div>
                              <div class="admin-reservation__actions">
                                <button class="btn btn-outline" data-open="#editReservationModal-<%= reservation.reservation_id %>">Edit</button>
                                <form class="inline-form js-confirm"
                                      data-confirm="Remove this volunteer from the time block?"
                                      data-confirm-cta="Remove"
                                      action="/admin/reservation/<%= reservation.reservation_id %>/delete"
                                      method="POST">
                                  <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
                                  <input type="hidden" name="eventId" value="<%= event.event_id %>">
                                  <input type="hidden" name="station_id" value="<%= station.station_id %>">
                                  <button type="submit" class="btn btn-danger">Remove</button>
                                </form>
                              </div>
                            </li>

                            <%- include('../partials/modal-start', { id: 'editReservationModal-' + reservation.reservation_id, title: 'Edit Volunteer' }) %>
                              <form id="editReservationForm-<%= reservation.reservation_id %>" action="/admin/reservation/<%= reservation.reservation_id %>/edit" method="POST" novalidate>
                                <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
                                <input type="hidden" name="eventId" value="<%= event.event_id %>">
                                <input type="hidden" name="station_id" value="<%= station.station_id %>">
                                <div class="form-grid">
                                  <div class="form-group">
                                    <label for="reservation-name-<%= reservation.reservation_id %>">Name</label>
                                    <input type="text" id="reservation-name-<%= reservation.reservation_id %>" name="name" value="<%= reservation.name %>" required>
                                  </div>
                                  <div class="form-group">
                                    <label for="reservation-email-<%= reservation.reservation_id %>">Email</label>
                                    <input type="email" id="reservation-email-<%= reservation.reservation_id %>" name="email" value="<%= reservation.email %>" required>
                                  </div>
                                  <div class="form-group">
                                    <label for="reservation-phone-<%= reservation.reservation_id %>">Phone</label>
                                    <input type="tel" id="reservation-phone-<%= reservation.reservation_id %>" name="phone" value="<%= reservation.phone %>">
                                  </div>
                                  <div class="form-group">
                                    <label for="reservation-block-<%= reservation.reservation_id %>">Assign to time block</label>
                                    <select id="reservation-block-<%= reservation.reservation_id %>" name="block_id">
                                      <% event.stations.forEach(function(optStation) { %>
                                        <%
                                          const optBlocks = Array.isArray(optStation.time_blocks)
                                            ? optStation.time_blocks
                                            : (optStation.time_blocks ? Object.values(optStation.time_blocks) : []);
                                          if (!optBlocks.length) return;
                                        %>
                                        <optgroup label="<%= isPotluck ? 'Category' : 'Station' %>: <%= optStation.name %>">
                                          <% optBlocks.forEach(function(optBlock) { %>
                                            <option value="<%= optBlock.block_id %>" <%= optBlock.block_id === block.block_id ? 'selected' : '' %>>
                                              <%= fmt12(optBlock.start_time) %> – <%= fmt12(optBlock.end_time) %>
                                            </option>
                                          <% }) %>
                                        </optgroup>
                                      <% }) %>
                                    </select>
                                  </div>
                                </div>
                              </form>
                            <%- include('../partials/modal-end', { id: 'editReservationModal-' + reservation.reservation_id, formId: 'editReservationForm-' + reservation.reservation_id }) %>
                          <% }) %>
                        </ul>
                      <% } else { %>
                        <p class="muted">No volunteers yet.</p>
                      <% } %>
                    </details>
                  </div>
                  <div class="admin-block__actions">
                    <button class="btn btn-primary" data-open="#addReservationModal-<%= block.block_id %>" <%= block.is_full ? 'disabled title="Time block is full"' : '' %>>Add volunteer</button>
                    <button class="btn btn-outline" data-open="#editBlockModal-<%= block.block_id %>"><%= isPotluck ? 'Edit item' : 'Edit block' %></button>
                    <% if (!isPotluck) {
                         const startDt = parseLocalDate(block.start_time);
                         const endDt = parseLocalDate(block.end_time);
                         const durationMs = (startDt && endDt) ? (endDt.getTime() - startDt.getTime()) : null;
                         const nextStart = endDt || null;
                         const nextEnd = (nextStart && durationMs != null) ? new Date(nextStart.getTime() + durationMs) : null;
                         const fmtInput = (dt) => dt ? `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())}T${pad2(dt.getHours())}:${pad2(dt.getMinutes())}` : '';
                    %>
                      <button class="btn btn-ghost"
                              data-open="#timeBlockModal"
                              data-station-id="<%= station.station_id %>"
                              data-event-id="<%= event.event_id %>"
                              data-next-start="<%= fmtInput(nextStart) %>"
                              data-next-end="<%= fmtInput(nextEnd) %>"
                              data-next-capacity="<%= block.capacity_needed %>">
                        Add next block
                      </button>
                    <% } %>
                    <form class="inline-form js-confirm"
                          data-confirm="Delete this time block? This cannot be undone."
                          data-confirm-cta="Delete"
                          action="/admin/block/<%= block.block_id %>/delete"
                          method="POST">
                      <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
                      <input type="hidden" name="eventId" value="<%= event.event_id %>">
                      <input type="hidden" name="station_id" value="<%= station.station_id %>">
                      <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                  </div>
                </li>

                <%- include('../partials/modal-start', { id: 'addReservationModal-' + block.block_id, title: 'Add Volunteer to Time Block' }) %>
                  <form id="addReservationForm-<%= block.block_id %>" action="/admin/block/<%= block.block_id %>/reservations" method="POST" novalidate>
                    <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
                    <input type="hidden" name="eventId" value="<%= event.event_id %>">
                    <input type="hidden" name="station_id" value="<%= station.station_id %>">
                    <div class="form-grid">
                      <div class="form-group">
                        <label for="add-reservation-name-<%= block.block_id %>">Name</label>
                        <input type="text" id="add-reservation-name-<%= block.block_id %>" name="name" required>
                      </div>
                      <div class="form-group">
                        <label for="add-reservation-email-<%= block.block_id %>">Email</label>
                        <input type="email" id="add-reservation-email-<%= block.block_id %>" name="email" required>
                      </div>
                      <div class="form-group">
                        <label for="add-reservation-phone-<%= block.block_id %>">Phone</label>
                        <input type="tel" id="add-reservation-phone-<%= block.block_id %>" name="phone">
                      </div>
                      <% if (isPotluck) { %>
                        <div class="form-group full">
                          <label for="add-reservation-dish-<%= block.block_id %>">Dish name</label>
                          <input type="text"
                                 id="add-reservation-dish-<%= block.block_id %>"
                                 name="dish_note"
                                 placeholder="What dish will they bring?"
                                 required>
                        </div>
                      <% } %>
                    </div>
                  </form>
                <%- include('../partials/modal-end', { id: 'addReservationModal-' + block.block_id, formId: 'addReservationForm-' + block.block_id }) %>

                <!-- Edit Block Modal -->
                <%- include('../partials/modal-start', { id: 'editBlockModal-' + block.block_id, title: isPotluck ? 'Edit Item' : 'Edit Time Block' }) %>
                  <form id="editBlockForm-<%= block.block_id %>" action="/admin/block/<%= block.block_id %>/edit" method="POST" novalidate>
                    <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
                    <input type="hidden" name="eventId" value="<%= event.event_id %>">
                    <input type="hidden" name="station_id" value="<%= station.station_id %>">
        <div class="form-grid two">
          <% if (isPotluck) { %>
            <div class="form-group full">
              <label for="block-title-<%= block.block_id %>">Item name</label>
              <input id="block-title-<%= block.block_id %>" type="text" name="title" value="<%= block.title || '' %>">
            </div>
            <div class="form-group">
              <label for="block-servings-min-<%= block.block_id %>">Feeds (min)</label>
              <input id="block-servings-min-<%= block.block_id %>" type="number" name="servings_min" min="0" value="<%= (typeof block.servings_min !== 'undefined' && block.servings_min != null) ? block.servings_min : '' %>">
            </div>
            <div class="form-group">
              <label for="block-servings-max-<%= block.block_id %>">Feeds (max)</label>
              <input id="block-servings-max-<%= block.block_id %>" type="number" name="servings_max" min="0" value="<%= (typeof block.servings_max !== 'undefined' && block.servings_max != null) ? block.servings_max : '' %>">
            </div>
          <% } else { %>
            <div class="form-group">
              <label for="block-start-visible-<%= block.block_id %>">Start time</label>
              <input type="hidden"
                     id="block-start-hidden-<%= block.block_id %>"
                     name="start_time"
                     value="<%= canonicalLocal(block.start_time) %>">
              <input type="datetime-local"
                     id="block-start-visible-<%= block.block_id %>"
                     class="datetime-field"
                     data-datetime-role="start"
                     data-canonical-target="block-start-hidden-<%= block.block_id %>"
                     step="900"
                     value="<%= canonicalInputValue(block.start_time) %>"
                     required>
            </div>
            <div class="form-group">
              <label for="block-end-visible-<%= block.block_id %>">End time</label>
              <input type="hidden"
                     id="block-end-hidden-<%= block.block_id %>"
                     name="end_time"
                     value="<%= canonicalLocal(block.end_time) %>">
              <input type="datetime-local"
                     id="block-end-visible-<%= block.block_id %>"
                     class="datetime-field"
                     data-datetime-role="end"
                     data-canonical-target="block-end-hidden-<%= block.block_id %>"
                     step="900"
                     value="<%= canonicalInputValue(block.end_time) %>"
                     required>
            </div>
          <% } %>
          <div class="form-group">
                        <label for="block-capacity-<%= block.block_id %>">Slots</label>
            <input id="block-capacity-<%= block.block_id %>"
                   type="number"
                   name="capacity_needed"
                   min="1"
                   value="<%= block.capacity_needed %>"
                   required>
          </div>
        </div>
                  </form>
                <%- include('../partials/modal-end', { id: 'editBlockModal-' + block.block_id, formId: 'editBlockForm-' + block.block_id }) %>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="muted"><%= isPotluck ? 'No items yet. Click “Add item”.' : 'No time blocks yet. Click “Add time block”.' %></p>
          <% } %>
        </article>

        <!-- Edit Station Modal -->
        <%- include('../partials/modal-start', { id: 'editStationModal-' + station.station_id, title: isPotluck ? 'Edit Category' : 'Edit Station' }) %>
          <form id="editStationForm-<%= station.station_id %>" action="/admin/station/<%= station.station_id %>/edit" method="POST" novalidate>
            <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
            <input type="hidden" name="eventId" value="<%= event.event_id %>">
            <div class="form-group">
              <label for="station-name-<%= station.station_id %>"><%= isPotluck ? 'Category name' : 'Station name' %></label>
              <input id="station-name-<%= station.station_id %>" type="text" name="name" value="<%= station.name %>" required>
            </div>
            <div class="form-group">
              <label for="station-about-<%= station.station_id %>"><%= isPotluck ? 'Category description' : 'Station description' %></label>
              <textarea id="station-about-<%= station.station_id %>" name="about" rows="3" placeholder="Describe the purpose of this station"><%= station.about || station.description || '' %></textarea>
            </div>
            <% if (!isPotluck) { %>
              <div class="form-group">
                <label for="station-duties-<%= station.station_id %>">Volunteer duties</label>
                <textarea id="station-duties-<%= station.station_id %>" name="duties" rows="3" placeholder="List expectations or tasks for volunteers"><%= station.duties || '' %></textarea>
              </div>
            <% } %>
            <%- include('../partials/formatting-help-inline') %>
          </form>
        <%- include('../partials/modal-end', { id: 'editStationModal-' + station.station_id, formId: 'editStationForm-' + station.station_id }) %>

        <% if (isPotluck && sortedBlocks.length > 0) { %>
          <!-- Reorder Items Modal -->
          <%- include('../partials/modal-start', { id: 'reorderItemsModal-' + station.station_id, title: 'Reorder Items' }) %>
            <div class="form-group">
              <p class="muted">Drag items up or down to change the order they appear in this category.</p>
            </div>
            <ul class="item-reorder-list" data-station-id="<%= station.station_id %>">
              <% sortedBlocks.forEach(function(block) { %>
                <li class="item-reorder-row" data-block-id="<%= block.block_id %>">
                  <span class="block-drag-handle" aria-hidden="true" title="Drag to reorder item">☰</span>
                  <span class="item-reorder-name"><%= block.title || '(untitled item)' %></span>
                </li>
              <% }) %>
            </ul>
          <%- include('../partials/modal-end', { id: 'reorderItemsModal-' + station.station_id, formId: undefined }) %>
        <% } %>
      <% }) %>
    </div>

    <!-- Reorder Stations Modal -->
    <%- include('../partials/modal-start', { id: 'reorderStationsModal', title: isPotluck ? 'Reorder Categories' : 'Reorder Stations' }) %>
      <div class="form-group">
        <p class="muted">Drag <%= isPotluck ? 'categories' : 'stations' %> up or down to change the order they appear on the event.</p>
        <% if (!isPotluck) { %>
          <button type="button" class="btn btn-ghost btn-small js-sort-stations-by-time">
            Sort by date & time
          </button>
        <% } %>
      </div>
      <ul class="item-reorder-list station-reorder-list" data-event-id="<%= event.event_id %>">
        <% stations.forEach(function(station) {
             const blockTimes = Array.isArray(station.time_blocks) ? station.time_blocks : [];
             const earliestTs = blockTimes.reduce((min, block) => {
               const ts = toTimestamp(block && block.start_time);
               if (!Number.isFinite(ts)) return min;
               return min === null ? ts : Math.min(min, ts);
             }, null);
        %>
          <li class="item-reorder-row station-reorder-row"
              data-station-id="<%= station.station_id %>"
              data-start-ts="<%= earliestTs === null ? '' : earliestTs %>">
            <span class="drag-handle" aria-hidden="true" title="Drag to reorder">☰</span>
            <span class="item-reorder-name"><%= station.name %></span>
          </li>
        <% }) %>
      </ul>
    <%- include('../partials/modal-end', {
      id: 'reorderStationsModal',
      formId: undefined,
      footer: `
        <button class="btn btn-secondary" data-close="#reorderStationsModal">Cancel</button>
        <button class="btn btn-primary js-reorder-stations-confirm" data-close="#reorderStationsModal">OK</button>
      `
    }) %>
  <% } else { %>
    <article class="card card--plain empty-state">
      <h2>No stations yet</h2>
      <p class="muted">Add a station to begin scheduling volunteer shifts for this event.</p>
    </article>
  <% } %>
</section>

<!-- Edit Event Modal -->
<%- include('../partials/modal-start', { id: 'editEventModal', title: 'Edit Event' }) %>
  <form id="editEventForm" action="/admin/event/<%= event.event_id %>/edit" method="POST" novalidate>
    <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
    <div class="form-group">
      <label for="edit-event-name">Event name</label>
      <input id="edit-event-name" type="text" name="name" value="<%= event.name %>" required>
    </div>
    <div class="form-group">
      <label for="edit-event-description">Description</label>
      <textarea id="edit-event-description" name="description"><%= event.description %></textarea>
      <%- include('../partials/formatting-help-inline') %>
    </div>
        <div class="form-grid two">
          <div class="form-group">
            <label for="edit-event-start-visible">Start</label>
            <input type="hidden"
                   id="edit-event-start-hidden"
                   name="date_start"
                   value="<%= canonicalLocal(event.date_start) %>">
            <input type="datetime-local"
                   id="edit-event-start-visible"
                   class="datetime-field"
                   data-datetime-role="start"
                   data-canonical-target="edit-event-start-hidden"
                   step="900"
                   value="<%= canonicalInputValue(event.date_start) %>"
                   required>
          </div>
          <div class="form-group">
            <label for="edit-event-end-visible">End</label>
            <input type="hidden"
                   id="edit-event-end-hidden"
                   name="date_end"
                   value="<%= canonicalLocal(event.date_end) %>">
            <input type="datetime-local"
                   id="edit-event-end-visible"
                   class="datetime-field"
                   data-datetime-role="end"
                   data-canonical-target="edit-event-end-hidden"
                   step="900"
                   value="<%= canonicalInputValue(event.date_end) %>"
                   required>
          </div>
        </div>
    <div class="form-group">
      <label for="edit-event-signup-mode">Sign-up type</label>
      <select id="edit-event-signup-mode" name="signup_mode">
        <option value="schedule" <%= (String(event.signup_mode||'')==='schedule') ? 'selected' : '' %>>Volunteer schedule (stations &amp; time slots)</option>
        <option value="potluck" <%= (String(event.signup_mode||'')==='potluck') ? 'selected' : '' %>>Potluck (categories &amp; items, no times)</option>
      </select>
    </div>
  </form>
<%- include('../partials/modal-end', { id: 'editEventModal', formId: 'editEventForm' }) %>

<!-- New Station Modal -->
<%- include('../partials/modal-start', { id: 'newStationModal', title: isPotluck ? 'Add New Category' : 'Add New Station' }) %>
  <form id="newStationForm" action="/admin/event/<%= event.event_id %>/stations" method="POST" novalidate>
    <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
    <div class="form-group">
      <label for="new-station-name"><%= isPotluck ? 'Category name' : 'Station name' %></label>
      <input id="new-station-name" type="text" name="name" placeholder="<%= isPotluck ? 'Category Name' : 'Station Name' %>" required>
    </div>
    <div class="form-group">
      <label for="new-station-about"><%= isPotluck ? 'Category description' : 'Station description' %></label>
      <textarea id="new-station-about" name="about" placeholder="<%= isPotluck ? 'Example: Main Dishes' : 'Example: Greeting table for first-time guests' %>" rows="3"></textarea>
    </div>
    <% if (!isPotluck) { %>
      <div class="form-group">
        <label for="new-station-duties">Volunteer duties</label>
        <textarea id="new-station-duties" name="duties" placeholder="Example: Welcome guests, hand out info cards" rows="3"></textarea>
      </div>
    <% } %>
    <%- include('../partials/formatting-help-inline') %>
    <% if (stations.length > 0) { %>
      <div class="form-group">
        <label for="station-copy-source">Copy existing station (optional)</label>
        <select id="station-copy-source" name="copyStationId">
          <option value="">Do not copy</option>
          <% stations.forEach(function(srcStation) { %>
            <option value="<%= srcStation.station_id %>"><%= srcStation.name %></option>
          <% }) %>
        </select>
        <p class="muted copy-hint">Copies time blocks. Provide a new name and station details above.</p>
      </div>
    <% } %>
  </form>
<%- include('../partials/modal-end', { id: 'newStationModal', formId: 'newStationForm' }) %>

<!-- Add Time Block Modal -->
<%- include('../partials/modal-start', { id: 'timeBlockModal', title: isPotluck ? 'Add New Item' : 'Add New Time Block' }) %>
  <form id="timeBlockForm" action="" method="POST" novalidate>
    <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
    <input type="hidden" name="event_id" value="<%= event.event_id %>">
        <div class="form-grid two">
          <% if (isPotluck) { %>
            <div class="form-group full">
              <label for="timeblock-title">Item name</label>
              <input id="timeblock-title" type="text" name="title" placeholder="e.g., Main dish: Casserole" required>
            </div>
            <!-- For potluck, use event start/end behind the scenes -->
            <input type="hidden" id="timeblock-start-hidden" name="start_time" value="<%= canonicalLocal(event.date_start) %>">
            <input type="hidden" id="timeblock-end-hidden" name="end_time" value="<%= canonicalLocal(event.date_end) %>">
            <div class="form-group">
              <label for="timeblock-servings-min">Feeds (min)</label>
              <input id="timeblock-servings-min" type="number" name="servings_min" min="0" placeholder="e.g., 6">
            </div>
            <div class="form-group">
              <label for="timeblock-servings-max">Feeds (max)</label>
              <input id="timeblock-servings-max" type="number" name="servings_max" min="0" placeholder="e.g., 8">
            </div>
          <% } else { %>
            <div class="form-group">
              <label for="timeblock-start-visible">Start time</label>
              <input type="hidden" id="timeblock-start-hidden" name="start_time" value="">
              <input type="datetime-local"
                     id="timeblock-start-visible"
                     class="datetime-field"
                     data-datetime-role="start"
                     data-canonical-target="timeblock-start-hidden"
                     step="900"
                     required>
            </div>
            <div class="form-group">
              <label for="timeblock-end-visible">End time</label>
              <input type="hidden" id="timeblock-end-hidden" name="end_time" value="">
              <input type="datetime-local"
                     id="timeblock-end-visible"
                     class="datetime-field"
                     data-datetime-role="end"
                     data-canonical-target="timeblock-end-hidden"
                     step="900"
                     required>
            </div>
          <% } %>
      <div class="form-group">
        <label for="timeblock-capacity">Slots</label>
        <input id="timeblock-capacity" type="number" name="capacity_needed" min="1" value="1" required>
      </div>
    </div>
    <div class="form-errors notice notice--error" id="timeBlockErrors" style="display:none;"></div>
    <div class="form-group">
      <label>
        <input type="checkbox" id="timeblock-add-another" name="add_another" value="1">
        Add another after saving
      </label>
    </div>
  </form>
<%- include('../partials/modal-end', { id: 'timeBlockModal', formId: 'timeBlockForm' }) %>

<!-- Export CSV Options Modal -->
<%- include('../partials/modal-start', { id: 'exportCsvModal', title: 'Advanced Export' }) %>
  <form id="exportCsvForm" action="/admin/event/<%= event.event_id %>/export.csv" method="GET" novalidate>
    <fieldset>
      <legend>Columns</legend>
      <div class="form-grid two">
        <div>
          <strong>Event</strong>
          <label><input type="checkbox" name="fields" value="event_id"> Event ID</label>
          <label><input type="checkbox" name="fields" value="event_name" checked> Event</label>
          <label><input type="checkbox" name="fields" value="event_type"> Event Type</label>
          <label><input type="checkbox" name="fields" value="event_description"> Description</label>
          <label><input type="checkbox" name="fields" value="event_start" checked> Event Start</label>
          <label><input type="checkbox" name="fields" value="event_end" checked> Event End</label>
        </div>
        <div>
          <strong>Station/Category</strong>
          <label><input type="checkbox" name="fields" value="station_id"> Station ID</label>
          <label><input type="checkbox" name="fields" value="station_name" checked> Station/Category</label>
          <label><input type="checkbox" name="fields" value="station_about"> About</label>
          <label><input type="checkbox" name="fields" value="station_duties"> Duties</label>
        </div>
        <div>
          <strong>Time Block</strong>
          <label><input type="checkbox" name="fields" value="block_id"> Block ID</label>
          <label><input type="checkbox" name="fields" value="item_title" <%= isPotluck ? 'checked' : '' %>> Item Title</label>
          <label><input type="checkbox" name="fields" value="block_start" checked> Block Start</label>
          <label><input type="checkbox" name="fields" value="block_end" checked> Block End</label>
          <label><input type="checkbox" name="fields" value="capacity_needed"> Slots/Units</label>
          <label><input type="checkbox" name="fields" value="servings"> Feeds</label>
          <label><input type="checkbox" name="fields" value="reserved_count"> Reserved Count</label>
          <label><input type="checkbox" name="fields" value="is_full"> Is Full</label>
        </div>
        <div>
          <strong>Volunteer</strong>
          <label><input type="checkbox" name="fields" value="volunteer_id"> Volunteer ID</label>
          <label><input type="checkbox" name="fields" value="volunteer_name" checked> Name</label>
          <label><input type="checkbox" name="fields" value="volunteer_email" checked> Email</label>
          <label><input type="checkbox" name="fields" value="volunteer_phone" checked> Phone</label>
          <label><input type="checkbox" name="fields" value="reservation_id"> Reservation ID</label>
          <label><input type="checkbox" name="fields" value="reservation_date" checked> Reservation Date</label>
          <label><input type="checkbox" name="fields" value="dish_name"> Dish Name</label>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Sort</legend>
      <select name="sort">
        <option value="time_station_name" selected>Time, then Station, then Name</option>
        <option value="station_time_name">Station, then Time, then Name</option>
        <option value="station_only">Station, then Name</option>
      </select>
    </fieldset>

    <fieldset>
      <legend>Filter</legend>
      <div class="form-grid two">
        <div class="form-group">
          <label for="export-stations">Stations</label>
          <select id="export-stations" name="station_id" multiple size="5">
            <% stations.forEach(function(s) { %>
              <option value="<%= s.station_id %>"><%= s.name %></option>
            <% }) %>
          </select>
          <p class="muted">Hold Ctrl/Cmd to select multiple</p>
        </div>
        <div>
          <div class="form-group">
            <label for="export-start-visible">Start on/after</label>
            <input type="hidden" id="export-start" name="start" value="">
            <input type="datetime-local"
                   id="export-start-visible"
                   class="datetime-field"
                   data-canonical-target="export-start"
                   step="900">
          </div>
          <div class="form-group">
            <label for="export-end-visible">End on/before</label>
            <input type="hidden" id="export-end" name="end" value="">
            <input type="datetime-local"
                   id="export-end-visible"
                   class="datetime-field"
                   data-canonical-target="export-end"
                   step="900">
          </div>
        </div>
      </div>
    </fieldset>
  </form>
<%- include('../partials/modal-end', { id: 'exportCsvModal', formId: 'exportCsvForm', footer: undefined }) %>

<%- include('../partials/footer') %>
