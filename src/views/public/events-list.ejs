<%- include('../partials/header', { title, user: locals.user, layoutVariant: 'public' }) %>

<section class="page-header page-header--compact page-shell">
  <div class="page-header__intro page-header__intro--full">
    <h1>Upcoming Sign-ups</h1>
    <p class="page-subtitle">Browse open volunteer shifts, outreach projects, and food prep items—then choose what fits your schedule.</p>
    <%
      const brandInfo = locals.brand || {};
      const supportEmail = brandInfo.supportContactEmail || '';
      const supportName = brandInfo.supportContactName || brandInfo.orgName || 'our team';
    %>
    <details class="page-help">
      <summary class="page-help__summary">
        <span class="page-help__summary-title">Need help getting started?</span>
        <span class="page-help__summary-meta">Tap or click for quick tips</span>
      </summary>
      <div class="page-help__body">
        <p>
          New here? <a href="/help">Read the volunteer help guide</a> for a quick walk-through on how to reserve a time or item.
        </p>
        <% if (supportEmail) { %>
          <p class="page-help__contact">
            Questions? Email <strong><%= supportName %></strong> at
            <a class="page-help__email" href="mailto:<%= supportEmail %>"><%= supportEmail %></a>.
          </p>
        <% } else { %>
          <p class="page-help__contact">Questions? Reply to your confirmation email and we’ll be in touch.</p>
        <% } %>
      </div>
    </details>
  </div>
</section>

<%- include('../partials/messages', { messages: locals.messages || {} }) %>

<section class="page-section page-shell">
  <div class="tile-grid">
    <% events.forEach(event => { %>
      <% const start = new Date(event.date_start); const end = new Date(event.date_end); %>
      <% const sameDay = start.getFullYear() === end.getFullYear() && start.getMonth() === end.getMonth() && start.getDate() === end.getDate(); %>
      <% const timeOnly = (d) => new Date(d).toLocaleTimeString(undefined, { hour:'numeric', minute:'2-digit' }); %>
      <% const isPotluck = String(event.signup_mode || '').toLowerCase() === 'potluck'; %>
      <% const heroLabel = isPotluck ? 'Food Prep event' : 'Volunteer event'; %>
      <% const heroIcon = isPotluck ? '/img/event-icon-potluck.svg' : '/img/event-icon-volunteer.svg'; %>
      <% const metaClasses = ['event-card__meta', isPotluck ? 'event-card__meta--potluck' : '', sameDay ? '' : 'event-card__meta--multiday'].filter(Boolean).join(' '); %>
      <% const startDateLabel = start.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }); %>
      <% const endDateLabel = end.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }); %>
      <% const startISO = start.toISOString(); const endISO = end.toISOString(); %>
      <% const eventPath = `/events/${event.event_id}`; %>
      <% const shareBase = (typeof shareBaseUrl === 'string' && shareBaseUrl) ? shareBaseUrl : ''; %>
      <% const shareLink = shareBase ? (shareBase + eventPath) : eventPath; %>
      <article class="card event-card">
        <a class="event-card__link" href="/events/<%= event.event_id %>" aria-label="View details for <%= event.name %>"></a>
        <div class="event-card__hero <%= isPotluck ? 'event-card__hero--potluck' : 'event-card__hero--schedule' %>">
          <span class="event-card__hero-icon" aria-hidden="true">
            <img src="<%= heroIcon %>" alt="" loading="lazy" decoding="async">
          </span>
          <div class="event-card__hero-content">
            <p class="event-card__hero-label"><%= heroLabel %></p>
            <h2 class="event-card__title"><%= event.name %></h2>
            <% if (event.description) { %>
              <div class="event-card__hero-text rich-text"><%- helpers.renderRichText(event.description) %></div>
            <% } else { %>
              <p class="event-card__hero-text"><%= isPotluck ? 'Sign up to prep food or bring an item.' : 'Pick a time slot to lend a hand.' %></p>
            <% } %>
          </div>
        </div>
        <div class="<%= metaClasses %>">
          <span class="event-card__meta-icon" aria-hidden="true">
            <img src="/img/event-icon-calendar.svg" alt="" loading="lazy" decoding="async">
          </span>
          <div>
            <% if (sameDay) { %>
              <p class="event-card__date"><time datetime="<%= startISO %>"><%= startDateLabel %></time></p>
              <p class="event-card__time">
                <time datetime="<%= startISO %>"><%= timeOnly(start) %></time>
                &nbsp;–&nbsp;
                <time datetime="<%= endISO %>"><%= timeOnly(end) %></time>
              </p>
            <% } else { %>
              <p class="event-card__date">Starts <time datetime="<%= startISO %>"><%= startDateLabel %> · <%= timeOnly(start) %></time></p>
              <p class="event-card__time">Ends <time datetime="<%= endISO %>"><%= endDateLabel %> · <%= timeOnly(end) %></time></p>
            <% } %>
          </div>
        </div>
        <div class="card-actions">
          <a href="/events/<%= event.event_id %>" class="btn btn-primary"><%= isPotluck ? 'Sign Up for Food Prep' : 'View sign-ups' %></a>
          <button type="button"
                  class="btn btn-outline share-link__copy-btn"
                  aria-label="Copy share link for <%= event.name %>"
                  title="Copy share link for <%= event.name %>"
                  data-copy-share-link="<%= shareLink %>"
                  data-label-default="Share link"
                  data-label-success="Link copied!"
                  data-label-error="Unable to copy">
            <svg class="share-link__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15 3a3 3 0 0 1 3 3v5a3 3 0 0 1-3 3h-1v-2h1a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v2H6V6a3 3 0 0 1 3-3h6Zm-6 8a3 3 0 0 1 3 3v5a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-5a3 3 0 0 1 3-3h3Zm0 2H6a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-5a1 1 0 0 0-1-1Z"/></svg>
            <span class="share-link__copy-label" aria-live="polite">Share link</span>
          </button>
        </div>
      </article>
    <% }) %>
  </div>
</section>

<%- include('../partials/footer') %>
