<%- include('../partials/header', { title, user: locals.user, layoutVariant: 'public' }) %>

<% const { fmt12 } = helpers; %>
<% const isPotluck = String(event.signup_mode || '').toLowerCase() === 'potluck'; %>
<% const stations = Array.isArray(event.stations) ? event.stations : Object.values(event.stations || {}); %>
<% const hasTimeBlocks = stations.some(s => Array.isArray(s.time_blocks) && s.time_blocks.length > 0); %>
<% const brandInfo = locals.brand || {}; %>
<% const supportEmail = brandInfo.supportContactEmail || ''; %>
<% const supportName = brandInfo.supportContactName || brandInfo.orgName || 'our team'; %>
<% const _s = new Date(event.date_start); const _e = new Date(event.date_end); const _same = _s.getFullYear()===_e.getFullYear() && _s.getMonth()===_e.getMonth() && _s.getDate()===_e.getDate(); %>

<section class="page-header page-shell">
  <div>
    <a href="/events" class="btn-link">&larr; Back to sign-ups</a>
    <h1>Manage your sign-up for <%= event.name %></h1>
    <% if (_same) { %>
      <p class="page-subtitle"><%= _s.toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric' }) %> — <%= _s.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'}) %> to <%= _e.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'}) %></p>
    <% } else { %>
      <p class="page-subtitle"><%= fmt12(event.date_start) %> — <%= fmt12(event.date_end) %></p>
    <% } %>
  </div>
  <div class="page-header__actions">
    <a href="/events/<%= event.event_id %>" class="btn btn-accent small">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11 19l-7-7 7-7v4h9v6h-9v4z"/></svg>
      View event page
    </a>
  </div>
</section>

<section class="page-section page-shell">
  <article class="card card--plain">
    <% if (event.description) { %>
      <div class="rich-text"><%- helpers.renderRichText(event.description) %></div>
    <% } else { %>
      <p class="muted"><%= isPotluck ? 'Review your food prep items below.' : 'Review the stations and times below, then update your selections as needed.' %></p>
    <% } %>
    <p class="muted">Update or remove your selections using the list below, then choose "Save changes" to send yourself a confirmation email.</p>
    <p class="muted small">
      Need instructions? <a href="/help">Open the volunteer help guide</a><% if (supportEmail) { %> or email <%= supportName %> at <a href="mailto:<%= supportEmail %>"><%= supportEmail %></a><% } else { %>. If you are stuck, reply to your confirmation email.<% } %>
    </p>
    <p class="muted small">Your confirmation email contains this page’s link if you need it later.</p>
  </article>
</section>

<%- include('../partials/messages') %>

<% if (hasTimeBlocks) { %>
<section class="page-section page-shell">
  <% if (!isPotluck) { %>
    <div class="slot-toolbar">
      <div class="slot-toolbar__group">
        <label class="slot-toolbar__label" for="slot-view-mode">View selections by</label>
        <select id="slot-view-mode" class="slot-toolbar__select">
          <option value="station" selected>Station</option>
          <option value="time">Date &amp; time</option>
        </select>
      </div>
    </div>
    <div id="slots-by-time" class="slot-view slot-view--time" hidden>
      <ul id="slots-by-time-list" class="time-block-list"></ul>
    </div>
  <% } %>

  <div id="slots-by-station" class="slot-view slot-view--station">
    <h3 class="step-heading"><%= isPotluck ? 'Step 1: Review items' : 'Step 1: Review opportunities' %></h3>
    <div class="station-grid">
      <% stations.forEach(station => { %>
        <% const blocks = Array.isArray(station.time_blocks) ? station.time_blocks : (station.time_blocks ? Object.values(station.time_blocks) : []); %>
        <% if (blocks.length > 0) { %>
          <article class="card station-card">
            <div class="card-header">
            <div class="station-card__title">
              <h2><%= isPotluck ? 'Category' : 'Station' %>: <%= station.name %></h2>
              <% const stationAbout = station.about || station.description || ''; %>
              <% const stationDuties = station.duties || ''; %>
              <% const factCount = (stationAbout ? 1 : 0) + (stationDuties ? 1 : 0); %>
              <% if (stationAbout || stationDuties) { %>
                <div class="station-quick-facts <%= factCount === 1 ? 'station-quick-facts--single' : '' %>">
                  <% if (stationAbout) { %>
                    <div class="station-quick-fact">
                      <h3>Description</h3>
                      <div class="rich-text"><%- helpers.renderRichText(stationAbout) %></div>
                    </div>
                  <% } %>
                  <% if (stationDuties) { %>
                    <div class="station-quick-fact">
                      <h3>Duties</h3>
                      <div class="rich-text"><%- helpers.renderRichText(stationDuties) %></div>
                    </div>
                  <% } %>
                </div>
              <% } %>
            </div>
            </div>
            <ul class="time-block-list">
              <% blocks.forEach(block => { %>
                <% const isSelected = Array.isArray(selectedBlockIds) && selectedBlockIds.includes(block.block_id); %>
                <% var existingNote = ''; if (Array.isArray(reservations)) { for (var i=0;i<reservations.length;i++){ if (reservations[i].block_id === block.block_id) { existingNote = reservations[i].note || ''; break; } } } %>
                <li
                  class="time-block-item <%= block.is_full && !isSelected ? 'is-full' : '' %> <%= isSelected ? 'selected' : '' %> <%= isPotluck ? 'is-potluck' : '' %>"
                  data-block-id="<%= block.block_id %>"
                  data-station-id="<%= station.station_id %>"
                  data-station-name="<%= station.name %>"
                  data-start-time="<%= isPotluck ? '' : block.start_time %>"
                  data-end-time="<%= isPotluck ? '' : block.end_time %>"
                  <% if (isPotluck) { %>data-item-title="<%= (block.title || '').replace(/\"/g, '&quot;') %>"<% } %>
                  <% if (isPotluck) { %>data-dish-note="<%= (existingNote || '').replace(/\"/g, '&quot;') %>"<% } %>
                  data-is-full="<%= !!block.is_full && !isSelected %>"
                  role="button"
                  aria-pressed="<%= isSelected ? 'true' : 'false' %>"
                  tabindex="<%= block.is_full && !isSelected ? -1 : 0 %>"
                >
                  <div class="time-block-item__info">
                    <span class="station-chip muted" data-role="station-chip"><%= isPotluck ? 'Category' : 'Station' %>: <%= station.name %></span>
                    <% if (isPotluck) { %>
                      <strong><%= block.title || 'Item' %></strong>
                    <% } else { %>
                      <strong><%= helpers.fmtRange(block.start_time, block.end_time) %></strong>
                    <% } %>
                    <% if (isPotluck) { %>
                      <% const hasServings = block.servings_min != null || block.servings_max != null; %>
                      <% if (hasServings) { %>
                        <span class="muted">
                          • Feeds: <%= (block.servings_min != null) ? block.servings_min : '' %><%= (block.servings_max != null) ? ('–' + block.servings_max) : '' %>
                        </span>
                      <% } %>
                    <% } else { %>
                      <span class="muted"> • Slots: <%= block.capacity_needed %></span>
                    <% } %>
                    <span class="muted"> • Signed up: <%= block.reserved_count || 0 %><% if (typeof block.capacity_needed !== 'undefined' && block.capacity_needed != null) { %> / <%= block.capacity_needed %><% } %></span>
                    <span class="slot-conflict-note" data-role="conflict-note" hidden></span>
                    <div class="time-block-item__hint">
                      <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 15h-2v-2h2Zm0-4h-2V7h2Z"/></svg>
                      Click "Select" to <%= isPotluck ? 'update this item' : 'update this time block' %>.
                    </div>
                  </div>
                  <% if (isPotluck) { %>
                    <% const _notes = Array.isArray(block.dish_notes) ? block.dish_notes : []; const _shown = _notes.slice(0, 5); const _more = _notes.length - _shown.length; %>
                    <div class="time-block-item__others">
                      <% if (_shown.length) { %>
                        <div class="dish-notes-inline" title="Items others have signed up to prepare (duplicates welcome)"><svg class="info-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm-1.25 4.75h2.5v7h-2.5v-7Z"/></svg><strong class="muted">Others signed up</strong></div>
                        <ul class="dish-notes-list" title="Items others have signed up to prepare (duplicates welcome)">
                          <% _shown.forEach(function(n){ %>
                            <% if (typeof n === 'object') { %>
                              <li><%= n.text %><% if (n.by) { %> (<%= n.by %>)<% } %></li>
                            <% } else { %>
                              <li><%= n %></li>
                            <% } %>
                          <% }) %>
                          <% if (_more > 0) { %><li>+<%= _more %> more</li><% } %>
                        </ul>
                      <% } %>
                    </div>
                  <% } %>
                  <div class="time-block-item__action">
                    <% if (block.is_full && !isSelected) { %>
                      <span class="badge">Full</span>
                    <% } else { %>
                      <button type="button" class="btn btn-ghost select-slot-btn"><%= isSelected ? 'Selected' : (isPotluck ? 'Sign up' : 'Select') %></button>
                    <% } %>
                  </div>
                </li>
              <% }) %>
            </ul>
          </article>
        <% } %>
      <% }) %>
    </div>
  </div>
</section>

<% } else { %>
  <section class="page-section page-shell">
    <article class="card card--plain empty-state">
      <h2>No sign-ups available</h2>
      <p class="muted">We couldn’t find any sign-up opportunities for this event right now. Reach out to the coordinator if you need assistance.</p>
      <div class="action-row">
        <a class="btn btn-ghost" href="/events">Back to sign-ups</a>
      </div>
    </article>
  </section>
<% } %>

<section class="page-section page-shell">
  <% if (isPotluck) { %>
    <h3 id="step2Heading" class="step-heading">Step 2: Enter dish names <span id="selectedCountBadge" class="selection-count-badge" style="display:none;"></span></h3>
    <div id="selected-slots-panel" class="card card--plain signup-panel" style="display:block;">
      <div id="selected-slots-container"></div>
    </div>
    <h3 id="step3Heading" class="step-heading">Step 3: Save your changes</h3>
  <% } else { %>
    <h3 id="step2Heading" class="step-heading">Step 2: Save your changes <span id="selectedCountBadge" class="selection-count-badge" style="display:none;"></span></h3>
  <% } %>
  <div id="signup-form" class="card card--plain signup-panel" style="display:block;">
    <p class="muted">Select or deselect any selections above, then save. You can also remove all selections to cancel your signup.</p>
    <form id="signupFormTag" action="/manage/<%= token %>" method="POST" novalidate data-mode="manage" data-is-potluck="<%= isPotluck ? 'true' : 'false' %>">
      <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
      <div class="card-actions">
        <button type="submit" class="btn btn-primary">Save changes</button>
      </div>
    </form>
  </div>
</section>

<div id="selection-fab" class="selection-fab" hidden>
  <button type="button" class="selection-fab__button">Go to save changes</button>
</div>

<!-- Toast root + data hook for client-side snackbar (must be inside <body>) -->
<div id="toast-root" aria-live="polite" aria-atomic="true" style="position:fixed; inset: auto 0 max(16px, env(safe-area-inset-bottom)) 0; display:flex; justify-content:center; pointer-events:none; z-index:2000;"></div>
<div id="manage-toast-data" hidden data-success="<%= (messages && messages.success && messages.success[0]) ? messages.success[0] : '' %>"></div>

<%- include('../partials/footer') %>
